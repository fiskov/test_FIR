#include "ks_Filter.h"

static int filter_taps[KS_FILTER_TAP_NUM] = {
  -418,
  148,
  101,
  54,
  10,
  -25,
  -48,
  -57,
  -51,
  -33,
  -3,
  34,
  74,
  110,
  138,
  154,
  156,
  144,
  120,
  88,
  55,
  26,
  7,
  1,
  7,
  24,
  45,
  63,
  70,
  58,
  25,
  -31,
  -104,
  -184,
  -261,
  -320,
  -350,
  -343,
  -294,
  -209,
  -98,
  25,
  143,
  237,
  294,
  306,
  277,
  215,
  137,
  66,
  22,
  24,
  80,
  188,
  333,
  490,
  624,
  700,
  684,
  556,
  306,
  -51,
  -486,
  -949,
  -1381,
  -1720,
  -1909,
  -1906,
  -1691,
  -1270,
  -678,
  27,
  770,
  1464,
  2030,
  2400,
  2528,
  2400,
  2030,
  1464,
  770,
  27,
  -678,
  -1270,
  -1691,
  -1906,
  -1909,
  -1720,
  -1381,
  -949,
  -486,
  -51,
  306,
  556,
  684,
  700,
  624,
  490,
  333,
  188,
  80,
  24,
  22,
  66,
  137,
  215,
  277,
  306,
  294,
  237,
  143,
  25,
  -98,
  -209,
  -294,
  -343,
  -350,
  -320,
  -261,
  -184,
  -104,
  -31,
  25,
  58,
  70,
  63,
  45,
  24,
  7,
  1,
  7,
  26,
  55,
  88,
  120,
  144,
  156,
  154,
  138,
  110,
  74,
  34,
  -3,
  -33,
  -51,
  -57,
  -48,
  -25,
  10,
  54,
  101,
  148,
  -418
};

void ks_Filter_init(ks_Filter* f) {
  int i;
  for(i = 0; i < KS_FILTER_TAP_NUM; ++i)
    f->history[i] = 0;
  f->last_index = 0;
}

void ks_Filter_put(ks_Filter* f, int input) {
  f->history[f->last_index++] = input;
  if(f->last_index == KS_FILTER_TAP_NUM)
    f->last_index = 0;
}

int ks_Filter_get(ks_Filter* f) {
  long long acc = 0;
  int index = f->last_index, i;
  for(i = 0; i < KS_FILTER_TAP_NUM; ++i) {
    index = index != 0 ? index-1 : KS_FILTER_TAP_NUM-1;
    acc += (long long)f->history[index] * filter_taps[i];
  };
  return acc >> 16;
}
