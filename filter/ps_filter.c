#include "ps_Filter.h"

static int filter_taps[PS_FILTER_TAP_NUM] = {
  -518,
  -43,
  -20,
  -44,
  -21,
  -44,
  -20,
  -42,
  -19,
  -40,
  -17,
  -36,
  -13,
  -32,
  -8,
  -26,
  -3,
  -20,
  4,
  -12,
  11,
  -4,
  19,
  5,
  27,
  13,
  36,
  22,
  45,
  31,
  53,
  40,
  61,
  47,
  68,
  54,
  73,
  60,
  78,
  64,
  81,
  66,
  82,
  67,
  82,
  66,
  79,
  62,
  74,
  57,
  67,
  49,
  58,
  39,
  47,
  27,
  34,
  14,
  19,
  -2,
  3,
  -18,
  -14,
  -36,
  -33,
  -54,
  -51,
  -72,
  -69,
  -91,
  -87,
  -108,
  -104,
  -124,
  -120,
  -138,
  -133,
  -149,
  -142,
  -158,
  -151,
  -163,
  -154,
  -165,
  -154,
  -163,
  -149,
  -156,
  -140,
  -144,
  -126,
  -127,
  -107,
  -106,
  -83,
  -79,
  -53,
  -47,
  -19,
  -11,
  19,
  30,
  62,
  75,
  109,
  124,
  159,
  175,
  212,
  229,
  267,
  285,
  323,
  342,
  380,
  399,
  436,
  455,
  492,
  510,
  545,
  562,
  596,
  612,
  644,
  657,
  688,
  699,
  726,
  735,
  759,
  765,
  787,
  789,
  807,
  806,
  822,
  817,
  829,
  821,
  829,
  817,
  822,
  806,
  807,
  789,
  787,
  765,
  759,
  735,
  726,
  699,
  688,
  657,
  644,
  612,
  596,
  562,
  545,
  510,
  492,
  455,
  436,
  399,
  380,
  342,
  323,
  285,
  267,
  229,
  212,
  175,
  159,
  124,
  109,
  75,
  62,
  30,
  19,
  -11,
  -19,
  -47,
  -53,
  -79,
  -83,
  -106,
  -107,
  -127,
  -126,
  -144,
  -140,
  -156,
  -149,
  -163,
  -154,
  -165,
  -154,
  -163,
  -151,
  -158,
  -142,
  -149,
  -133,
  -138,
  -120,
  -124,
  -104,
  -108,
  -87,
  -91,
  -69,
  -72,
  -51,
  -54,
  -33,
  -36,
  -14,
  -18,
  3,
  -2,
  19,
  14,
  34,
  27,
  47,
  39,
  58,
  49,
  67,
  57,
  74,
  62,
  79,
  66,
  82,
  67,
  82,
  66,
  81,
  64,
  78,
  60,
  73,
  54,
  68,
  47,
  61,
  40,
  53,
  31,
  45,
  22,
  36,
  13,
  27,
  5,
  19,
  -4,
  11,
  -12,
  4,
  -20,
  -3,
  -26,
  -8,
  -32,
  -13,
  -36,
  -17,
  -40,
  -19,
  -42,
  -20,
  -44,
  -21,
  -44,
  -20,
  -43,
  -518
};

void ps_Filter_init(ps_Filter* f) {
  int i;
  for(i = 0; i < PS_FILTER_TAP_NUM; ++i)
    f->history[i] = 0;
  f->last_index = 0;
}

void ps_Filter_put(ps_Filter* f, int input) {
  f->history[f->last_index++] = input;
  if(f->last_index == PS_FILTER_TAP_NUM)
    f->last_index = 0;
}

int ps_Filter_get(ps_Filter* f) {
  long long acc = 0;
  int index = f->last_index, i;
  for(i = 0; i < PS_FILTER_TAP_NUM; ++i) {
    index = index != 0 ? index-1 : PS_FILTER_TAP_NUM-1;
    acc += (long long)f->history[index] * filter_taps[i];
  };
  return acc >> 16;
}
